%%
% <latex>
% \title{BE 521: Homework 3 Questions\\{\normalsize Feature extraction} \\{\normalsize Spring 2021}}
% \author{68 points}
% \date{Due: Tuesday, 2/16/2021 10pm}
% \maketitle
% \textbf{Objective:} Extract features from data and build a simple detector
% </latex>

%% 
% <latex>
% \begin{center}
% \author{Jal Mahendra Panchal \\
%   \normalsize Collaborators: COLLABORATORS HERE \\}
% \end{center}
% </latex>

%%
% <latex> 
% \section{Features and Simulations (39 pts)} As you learned
% in class, features are the backbone of almost all detection
% strategies, from seizures in EEG to faces in images. Features are
% usually defined in journal articles as an equation or set of
% equations, and the task for the reader---if she wants to use that
% feature---is to implement that feature in code. In this section, you
% will explore and implement some features commonly used in EEG
% analysis and test them on simulated time-series data.
% \begin{enumerate}
%  \item Consider the following toy signal: 7 seconds of a 2 Hz sine
%  wave with a quarter period phase-shift, sampled at 100 Hz
%   \begin{enumerate}
%    \item Plot the signal. (2 pts)
% </latex>

%% Answer P1 Q1(a)
% <latex> 
% \\ Answer : \\
% </latex>

%%
% Signal characteristics : 
duration_s = 7;
signal_frequency_hz = 2;
sampling_frequency_hz = 100;
theta_rad =  pi/2;
t = 0: 1/sampling_frequency_hz : duration_s-1/sampling_frequency_hz;

sine_wave = sin(2*pi*signal_frequency_hz*t + theta_rad);

%%
% Plot
plot(t, sine_wave, 'Linewidth', 1);
title('Sine Wave')
xlabel('Time (s)')
ylabel('Amplitude')
ylim ([-1.5,1.5])

%%
% <latex>
% \item Using the Matlab functions for the difference, sum, and
%   absolute value of the elements in a vector (look them up if you
%   don't know them), create an anonymous function for the
%    line-length feature
% 	$ LL(\mathbf{x}) = \sum_{i=2}^{n} |x_i - x_{i-1}| $ in one line of
% 	Matlab code that uses no loops (i.e., the outputs of one function
% 	will be the inputs of another). Your function should look
% 	something like \begin{lstlisting}
% 	  LLFn = @(x) XXXXXX;
% 	\end{lstlisting}
% 	where \texttt{XXXXX} represents some use of the aformentioned functions and the input signal \texttt{x}. (4 pts)
% </latex>


%% Answer P1 Q1(b)
% <latex> 
% \\ Answer : \\
% </latex>

%% Line Length function
% We will define an anonymous funtionn to calculate line length
LLFn = @(x) sum(abs(diff(x)));

%%
% <latex>
%    \item What is the line length of this signal? (2 pts)
%   \end{enumerate}
% </latex>

%% Answer P1 Q1(c)
% <latex> 
% \\ Answer : \\
% </latex>


%%
%Calling the LLFn function
line_length = LLFn(sine_wave)

%%
% <latex> 
% The line length of the sine wave is 55.9921 units.
% </latex>

%%
% <latex>
%  \item Consider line length of the signal using a sliding window
%  with a certain amount of window overlap (or, to think of it another
%  way, displacement with each ``slide''). Now, instead of having just
%  one value for the line length, you will have a number of values.
%   \begin{enumerate}
% 	\item Given a signal \texttt{x} with sampling frequency
% 	\texttt{fs} and windows of length \texttt{winLen} and displacement
% 	\texttt{winDisp} (both in seconds), create an anonymous function
% 	called \texttt{NumWins} that calculates the number of possible
% 	(full) windows in your signal of length \texttt{xLen} (in
% 	samples), i.e., \begin{lstlisting}
% 	  NumWins = @(xLen, fs, winLen, winDisp) XXXXXX;
% 	\end{lstlisting} where \texttt{XXXXXX} is the single-line
% 	expression for this value. You may assume that \texttt{winDisp} is
% 	a factor of both \texttt{winLen} (as it usually is/should be)
% 	and the length (in seconds) of \texttt{x}. (4 pts) 
% </latex>

%% Answer P1 Q2(a)
% <latex> 
% \\ Answer : \\
% </latex>

%% Number of windows function
%The number of windows can be found using the following function
NumWins = @(xLen, fs, winLen, winDisp) floor((xLen-(winLen-winDisp))/(winDisp));

%%
% <latex>
%   \item Use this
% 	function to calculate the number of windows for the signal
% 	described in Question 1.1 for a 400 ms window with 200 ms
% 	displacement, i.e., the expression \begin{lstlisting}
% 	  NumWins(length(x), fs, winLen, winDisp)
% 	\end{lstlisting} 
% 	where \texttt{fs}, \texttt{winLen}, and \texttt{winDisp} are the appropriate values. (1 pt)
% </latex>

%% Answer P1 Q2(b)
% <latex> 
% \\ Answer : \\
% </latex>

%%
duration_ms = 7000;
win_len_ms = 400;
win_disp_ms = 200;
NumberOfWindows_2_1 = NumWins(duration_ms, sampling_frequency_hz, win_len_ms, win_disp_ms)

%%
% <latex> 
% The number of windows of length 400ms and displacement 200ms in a 7s signal are 34;
% </latex>


%%
% <latex>
% 	\item Repeat the above calculation for 50 ms window displacement. (1 pt)
% </latex>

%% Answer P1 Q2(c)
% <latex> 
% \\ Answer : \\
% </latex>

%%
duration_ms = 7000;
win_len_ms = 400;
win_disp_ms = 50;
NumberOfWindows_2_2 = NumWins(duration_ms, sampling_frequency_hz, win_len_ms, win_disp_ms)

%%
% <latex> 
% The number of windows of length 400ms and displacement 50ms in a 7s signal are 133;
% </latex>

%%
% <latex>
% 	\item Repeat the above calculation for 100 ms window displacement. (1 pt)
%   \end{enumerate}
% </latex>

%% Answer P1 Q2(d)
% <latex> 
% \\ Answer : \\
% </latex>

%%
duration_ms = 7000;
win_len_ms = 400;
win_disp_ms = 100;
NumberOfWindows_2_3 = NumWins(duration_ms, sampling_frequency_hz, win_len_ms, win_disp_ms)

%%
% <latex> 
% The number of windows of length 400ms and displacement 100ms in a 7s signal are 67;
% </latex>

%%
% <latex> 
%   \item 
%   \begin{enumerate}
%    \item Create a function (in another file) called
%    \texttt{MovingWinFeats(x, fs, winLen, winDisp, featFn)} that
%    returns a vector of the values of the feature on the signal
%    \texttt{x} in all the possible windows, where \texttt{featFn} is
%    a feature function like the one you wrote in Question 1.1.b. You
%    may find it useful to use your \texttt{NumWins} function (or at
%    least its expression). You may assume that the product of
%    \texttt{winDisp} and the sampling rate \texttt{fs} is an integer.
%    (6 pts) \\
% </latex>

%%
% <latex>
% Make sure your MovingWinFeats code is in your pdf. One way is to use the following Matlab code (in your script) to automatically
% load in the function's code (where we assume that the function is
% one directory up from the *.tex file). Windows users may need to
% change the forward-slash to a backslash. 
% </latex>

%   <latex>
%   \lstinputlisting{[path to] MovingWinFeats.m}
%   </latex>

%% Answer P1 Q3(a)
% <latex> 
% \\ Answer : \\
% \lstinputlisting{MovingWinFeats.m}
% </latex>


%%
% <latex>
%    \item Using the signal you defined in Question 1.1 and the function you created in Question 1.1.b, calculate the line-length over windows of length 400 ms and displacement 200 ms. (2 pts)
% </latex>

%% Answer P1 Q3(b)
% <latex> 
% \\ Answer : \\
% </latex>

%%
% Using function MovingWinFeats to calculate Line Length
x = sine_wave;
fs = sampling_frequency_hz;
winLen = 400 ; %in ms
winDisp = 200; %in ms
line_length_windows_3c = MovingWinFeats(x, fs, winLen, winDisp, LLFn);

%%
%Plotting linelength for each window
plot(line_length_windows)
title('Line Length for 400 ms winLen, 200 winDisp')
xlabel('window index')
ylabel('line length amplitude')
%%
% <latex>
%    \item Add a unit-amplitude 10 Hz signal (in the form of a sine wave) to your original signal and again calculate the line length over the same window and displacement. (2 pts)
%   \end{enumerate}
% </latex>

%% Answer P1 Q3(c)
% <latex> 
% \\ Answer : \\
% </latex>

%%
%Adding a 10 Hz signal 
duration_s = 7;
signal_frequency_hz = 10;
sampling_frequency_hz = 100;
t = 0: 1/sampling_frequency_hz : duration_s-1/sampling_frequency_hz;
sine_wave_10 = sin(2*pi*10*t);

sine_wave_cmb = sine_wave + sine_wave_10;

% Using function MovingWinFeats to calculate Line Length
x = sine_wave_cmb;
fs = sampling_frequency_hz;
winLen = 400 ; %in ms
winDisp = 200; %in ms
line_length_windows_3d = MovingWinFeats(x, fs, winLen, winDisp, LLFn);

%%
% <latex>
%   \item Code the following 3 additional features in MINIMAL lines of code (hint: each can be implemented in one line using the anonymous function trick).
%   \begin{enumerate}
%    \item Area, $\displaystyle A(\mathbf{x}) = \sum_{i=1}^{n} |x_i| $ \quad (2 pts)
% </latex>

%% Answer P1 Q4(a)
% <latex> 
% \\ Answer : \\
% </latex>

%%
AreaFn = @(x) sum(abs(x));

%%
% <latex>
%    \item Energy, $\displaystyle E(\mathbf{x}) = \sum_{i=1}^{n} x_i^2 $ \quad (2 pts)
% </latex>

%% Answer P1 Q4(b)
% <latex> 
% \\ Answer : \\
% </latex>

%%
EnergyFn = @(x) sum(x.^2);

%%
% <latex>
%    \item Zero-Crossings around mean,\\ $\displaystyle ZX(\mathbf{x}) = \sum_{i=2}^{n} \mathbf{1}(\mathbf{FromAbove}) \;\mbox{OR}\; \mathbf{1}(\mathbf{FromBelow})$, 
%        where $\mathbf{1}(\cdot)$ denotes the indicator function, which returns a zero if its argument is false and a one if it is true, 
%        $\mathbf{FromAbove}$ denotes $(x_{i-1} - \overline{x} > 0) \;\mbox{AND}\; (x_i - \overline{x} < 0)$, 
%        $\mathbf{FromBelow}$ denotes $(x_{i-1} - \overline{x} < 0) \;\mbox{AND}\; (x_i - \overline{x} > 0)$,
%        and $\overline{x}$ is the mean value of the elements in $x$. (4 pts)
% </latex>

%% Answer P1 Q4(c)
% <latex> 
% \\ Answer : \\
% </latex>

%%
% Here we first remove the mean from the signal
% Then we find values above and below the mean
% We then calculate the difference between the signs of consecutive values
% if the absolute value of this difference is > 2 then its a zero crossing
% We then find the number of indices where zero crossing occcurs.
ZeroCrossingFn = @(x) size(find(abs(diff(sign(x-mean(x))))>1),2);

%%
% <latex>
%    \item Plot the values of the four features on the combined signal in the first four cells of a 3x2 matlab subplot.
%    Use a 400 ms window with 100 ms displacement. Using the right-aligned convention (where the
%    ``official'' time of the feature is that of the last data point
%    in the window), give the appropriate time axis for each window
%    point. In addition, plot the original signal with the 2Hz and 10Hz
%    components in the last two cells of the 3x2 subplot (to make
%    comparing down the column easy). Ensure that the time axis in all
%    of your plots is the same. (6 pts)
% </latex>

%% Answer P1 Q4(d)
% <latex> 
% \\ Answer : \\
% </latex>

%% Computing values 4(d)
x = sine_wave_cmb;
fs = sampling_frequency_hz;
winLen = 400 ; %in ms
winDisp = 100; %in ms

[line_length_windows_4d, ni, win_start, win_end] = MovingWinFeats(x, fs, winLen, winDisp, LLFn);
area_4d = MovingWinFeats(x, fs, winLen, winDisp, AreaFn);
energy_4d = MovingWinFeats(x, fs, winLen, winDisp, EnergyFn);
zero_crossing_4d = MovingWinFeats(x, fs, winLen, winDisp, ZeroCrossingFn);


%% Plotting the graph 4(d)
t = 0: 1/sampling_frequency_hz : duration_s-1/sampling_frequency_hz;
t_win_end = t(ni+win_end);

subplot(3,2,1)
plot(t_win_end, line_length_windows_4d, 'o-', 'Linewidth', 1, 'Color',[0, 0.4470, 0.7410])
title('Line Length in window')
xlabel('Time (s)')
ylabel('line length amplitude')
ylim([0.995*min(line_length_windows_4d), 1.005*max(line_length_windows_4d)])

subplot(3,2,2)
plot(t_win_end, area_4d, 'o-', 'Linewidth', 1, 'Color', [0.8500, 0.3250, 0.0980])
title('Area in window')
xlabel('Time (s)')
ylabel('Area amplitude')
ylim([0.9*min(area_4d), 1.1*max(area_4d)])

subplot(3,2,3)
plot(t_win_end, energy_4d, 'o-', 'Linewidth', 1, 'Color', [0.4660, 0.6740, 0.1880])
title('Energy in window')
xlabel('Time (s)')
ylabel('Energy amplitude')
ylim([0.9*min(energy_4d), 1.1*max(energy_4d)])


subplot(3,2,4)
plot(t_win_end, zero_crossing_4d, 'o-', 'Linewidth', 1, 'Color', [0.9290, 0.6940, 0.1250])
title('Total Zero crossings in window')
xlabel('Time (s)')
ylabel('Number of Zero Crossings')
ylim([0.9*min(zero_crossing_4d), 1.1*max(zero_crossing_4d)])


subplot(3,2,5)
plot(t, x , 'Linewidth', 1)
title('Signal')
xlabel('Time (s)')
ylabel('Signal amplitude')
ylim([1.1*min(x), 1.1*max(x)])


subplot(3,2,6)
plot(t, x , 'Linewidth', 1)
title('Signal')
xlabel('Time (s)')
ylabel('Signal amplitude')
ylim([1.1*min(x), 1.1*max(x)])


suptitle('Features in window : 400 ms WinLen, 100ms WinDisp')
%%
% <latex>
%   \end{enumerate}
% \end{enumerate}  
% \section{Feature Overlays (17 pts)}
% In this section, you will use a line-length feature overlay on a segment of EEG containing a seizure. This data is stored in \texttt{I521\_A0003\_D001} 
% \begin{enumerate}
%  \item What is the length using hours:minutes:seconds:milliseconds of the recording? (Use getDuration) (2 pts)
% </latex>

%% Answer P2 Q1
% <latex> 
% \\ Answer : \\
% </latex>

%% Fetching signal
addpath(genpath('/Users/jalpanchal/git/be521'));

session_sez = IEEGSession('I521_A0003_D001', 'jalpanchal', 'jal_ieeglogin.bin');
sampling_frequency_hz_sez = session_ep.data.sampleRate;
duration_in_sec_sez = session_ep.data(1).rawChannels(1).get_tsdetails.getDuration/1e6;

sez_data = session_ep.data.getvalues(0, duration_in_sec_ep * 1e6, 1);

%%
datestr(seconds(duration_in_sec_sez),'HH:MM:SS:FFF')

%%
% <latex> 
% The duration of the signal I521\_A0003\_D001 in
% hours:minutes:seconds:milliseconds is 01:21:20:390.\\
% </latex>


%%
% <latex>
%  \item How many data points should we discard at the end if we want to clip the recording to the last full second? Do this clipping. (1 pt)
% </latex>

%% Answer P2 Q2
% <latex> 
% \\ Answer : \\
% The signal has 390ms of data which needs to be discarded. At 200 Hz and
% 5ms between every sample, we will have to discard the last 78 data
% points. \\
% </latex>

%%
% Discarding the last 78 data points
sez_data_trim = sez_data(1:end-78);


%%
% <latex>
%  \item If we want to overlay a feature trace on the original signal, we have to interpolate that feature (which has been calculated over windows) for each data point of the original signal. One of the simplest methods of doing this is called zero-order interpolation, where we just hold the value constant until we get to the next calculated value. For example, if we had a moving window of 1 second with 1 second displacement, the zero-order interpolated feature vector would have the same value the entire first second, then the same for the entire second second, etc, where each second contains the same number of points as the sampling frequency of the original signal.
%  \begin{enumerate}
%   \item Using the \texttt{repmat} and \texttt{reshape} functions, create an external function \texttt{zoInterp(x, numInterp} that copies each value of \texttt{x} \texttt{numInterp} times. You can implement this function in one line of code with no loops. Include the code for this function as you did in Question 1.3.a. (2 pts)
% </latex>

%% Answer P2 Q3(a)
% <latex> 
% \\ Answer : \\
% \lstinputlisting{zoInerp.m}
% </latex>


%%
% <latex>
%   \item Confirm that this function works correctly by expanding the length of the vector \texttt{1:5} by a factor of 5 and plotting with the command
%   \begin{lstlisting}
% 	plot(zoInterp(1:5,5),'-o')
%   \end{lstlisting}
%   where the \texttt{'-o'} option lets us see the individul points as well as the line that connects them. (2 pts)
%  \end{enumerate}
% </latex>



%%
% <latex>
%  \item Using a 5-second sliding window with 1-second displacement,
%  calculate the line length feature over the entire signal. Normalize
%  the line-length feature values to have a maximum twice that of the
%  original EEG signal maximum. Plot the signal in blue and overlay
%  the right-aligned line-length feature in yellow. Note: you will need
%  to pad your
%  signal in order to get them to line up correctly and be the
%  same length. Put the units of your time axis in minutes, and be
%  sure to add a legend in a location in the plot that does not cover
%  up any signal or feature. (6 pts)
% </latex>

%%
% <latex>
%  \item What threshold might you use on the raw line-length feature
%  vector (not the normalized one used for plotting) in order to
%  capture the 17 largest pre-seizure chirps that occur? (1 pt)
% </latex>

%%
% <latex>
%  \item Using this threshold value, in another plot draw red vertical lines at the leading point in time where the threshold is crossed. Add these vertical lines on top of the plot you made in Question 2.4. These events should capture the pre-seizure chirps, the seizure onset, and some flickering during the end of the seizure. (3 pts)
% </latex>

%%
% <latex>
% \end{enumerate}
% \section{Building a Detector (12 pts)}
% In this section, you will use the features you defined previously to build a seizure detector. Use the EEG data in the file \texttt{I521\_A0003\_D002} with channels \texttt{multiSz\_1}, and \texttt{multiSz\_2}.
% \begin{enumerate}
%  \item Plot the signal in \texttt{multiSz\_1} and draw vertical red lines at the times when you think the two seizures begin. (You should be able to do this without the need of any features.) (2 pts)
% </latex>

%%
% <latex>
%  \item Produce feature overlay plots similar to that of Question 2.4 for each of the four features you have implemented along with the red vertical lines at each seizure. Use the same 4-second sliding window with 1 second displacement. (4 pts)
% </latex>

%%
% <latex>
%  \item 
%   \begin{enumerate}
%    \item Based on your plots in the previous question, which of the
%    four features seems to give the largest signal (relative to the
%    background) for when a seizure occurs? Explain why you think this feature is the best. (3 pts)
% </latex>

%%
% <latex>
%    \item What threshold would you use to determine if a seizure is occurring? (1 pt)
% </latex>

%%
% <latex>
%   \end{enumerate}
% </latex>

%%
% <latex>
%  \item The signal in \texttt{multiSz\_2} contains another seizure (whose location should again be fairly obvious). Plot the data along with the feature and threshold (horizontal black line, with correct normalization for the signal in \texttt{data2}) you determined in the previous question. (2 pts)
% </latex>

%%
% <latex>
% \end{enumerate}
% </latex>


